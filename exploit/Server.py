import socketserver
import sys
import base64
import pickle

KEY = "TH15_1SNT_3V3N_MY_F1N4L_F0RM!"

ENCODING = 'UTF-8'


def handle_data(data):
    try:
        pickled = base64.decodebytes(data)
        try:
            obj = pickle.loads(pickled)
        except pickle.UnpicklingError:
            raise
        if callable(obj) is True:
            ret = bytes("OK!", ENCODING)
        else:
            ret = bytes("KO!", ENCODING)
    except:
        tinfo = sys.exc_info()
        ret = bytes(str(tinfo[0]) + ": " + str(tinfo[1]), ENCODING)
    return b''.join([ret, bytes('\r\n', ENCODING)])


class BaseServer(socketserver.BaseRequestHandler):
    def handle(self):
        print("Connection from: %s:%d" % self.client_address)
        while True:
            try:
                self.request.sendall(bytes(">>> ", ENCODING))
                self.data = self.request.recv(1024)
                if len(self.data) == 0:
                    break
                result = handle_data(self.data)
                self.request.sendall(result)
            except:
                break

if __name__ == '__main__':
    try:
        HOST = sys.argv[1]
    except IndexError:
        HOST = 'localhost'

    try:
        PORT = int(sys.argv[2])
    except IndexError:
        PORT = 8080

    server = socketserver.TCPServer((HOST, PORT), BaseServer)
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        server.shutdown()
